# IntegraÃ§Ã£o ContÃ­nua

A integraÃ§Ã£o contÃ­nua Ã© uma prÃ¡tica de desenvolvimento de software onde membros de uma equipe integram seu cÃ³digo frequentemente, geralmente cada um fazendo ao menos uma integraÃ§Ã£o diÃ¡ria, o que leva a mÃºltiplas integraÃ§Ãµes por dia.

Cada integraÃ§Ã£o Ã© automaticamente verificada por meio de um _build_ (construÃ§Ã£o do software) e testes automatizados, detectando problemas de integraÃ§Ã£o.

No ecosistema do GitHub, Ã© possÃ­vel utilizar o serviÃ§o [GitHub Actions](https://github.com/features/actions), o qual permite a criaÃ§Ã£o de um _workflow_ de integraÃ§Ã£o contÃ­nua.

## ConteÃºdos sugeridos ğŸ“š

- [DocumentaÃ§Ã£o oficial do Cypress sobre GitHub Action](https://docs.cypress.io/guides/continuous-integration/github-actions#Cypress-GitHub-Action)
- [DocumentaÃ§Ã£o da imagem cypress-io/github-action no GitHub](https://github.com/cypress-io/github-action#readme)

## ExercÃ­cio 1 ğŸ¯ - CI sem paralelizaÃ§Ã£o

1. Na raiz do projeto, crie um diretÃ³rio oculto chamado `.github/` e dentro dele, crie um subdiretÃ³rio chamado `workflows/`.

> ğŸ‘¨â€ğŸ« VocÃª deve ter a seguinte estrutura `.github/workflows/`

2. Dentro do diretÃ³rio `.github/workflows/`, crie um arquivo chamado `ci.yml`, com o seguinte conteÃºdo:

```yml
name: End-to-end tests
on: push
jobs:
  cypress-run:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Cypress run
        uses: cypress-io/github-action@v6

```

**ReferÃªncia:** https://github.com/cypress-io/github-action#end-to-end-testing

> ğŸ‘¨â€ğŸ« O nome do arquivo pode ser qualquer nome aleatÃ³rio. Eu escolhi `ci` porque significa integraÃ§Ã£o contÃ­nua (em inglÃªs - _continuous integration_).

3. Com o `git`, adicione todas suas alteraÃ§Ãµes Ã  Ã¡rea de _staging_ (`git add .`).
4. FaÃ§a um commit com a mensagem `Configure the ci workflow` (`git commit -m "Configure the ci workflow"`.)
5. Envie suas alteraÃ§Ãµes locais para seu fork remoto no GitHub (`git push origin main`.)
6. Acesse o GitHub e veja suas alteraÃ§Ãµes disparando o _workflow_ (e se tudo der certo, veja seus testes passando).

## ExercÃ­cio 2 ğŸ¯ - CI com paralelizaÃ§Ã£o

### ConteÃºdos sugeridos especÃ­ficos do plugin `cypress-split` ğŸ“š

- [DocumentaÃ§Ã£o oficial do plugin `cypress-split` no npm](https://www.npmjs.com/package/cypress-split)
- [Aprenda como rodar testes em paralelo na integraÃ§Ã£o contÃ­nua usando o plugin cypress-split](https://youtu.be/h4ogzgoHUTg)

1. Instale o plugin `cypress-split` como uma dependeÃªncia de desenvolvimento: `npm i cypress-split@1.24.7 -D`
2. Importe o `cypress-split` no arquivo de configuraÃ§Ãµes do Cypress (`cypress.config.js`) e o configure, conforme desmontrado abaixo:

```js
const { defineConfig } = require("cypress")

const cypressSplit = require("cypress-split")

module.exports = defineConfig({
  viewportHeight: 1024,
  viewportWidth: 1700,
  e2e: {
    fixturesFolder: false,
    setupNodeEvents(on, config) {
      cypressSplit(on, config)
      return config
    }
  },
})

```

3. Atualize o arquivo `.github/workflows/ci.yml` conforme abaixo":

```yml
name: End-to-end tests
on: push
jobs:
  tests:
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        containers: [1, 2]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Run Cypress tests in parallel ğŸ§ª
        uses: cypress-io/github-action@v6
        env:
          SPLIT: ${{ strategy.job-total }}
          SPLIT_INDEX: ${{ strategy.job-index }}

```

4. Com o `git`, adicione todas suas alteraÃ§Ãµes Ã  Ã¡rea de _staging_ (`git add .`).
5. FaÃ§a um commit com a mensagem `Configure cypress-split` (`git commit -m "Configure cypress-split"`.)
6. Envie suas alteraÃ§Ãµes locais para seu fork remoto no GitHub (`git push origin main`.)
7. Acesse o GitHub e veja suas alteraÃ§Ãµes disparando o _workflow_ (e se tudo der certo, veja seus testes passando), onde dessa vez, ambos os arquivos da pasta `cypress/e2e/` serÃ£o executados em paralelo, otimizando o _feedback loop_.

## ExercÃ­cio 3 ğŸ¯ - Artefatos

1. Atualize o arquivo `.github/workflows/ci.yml` conforme abaixo":

```yml
name: End-to-end tests
on: push
jobs:
  tests:
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        containers: [1, 2]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Run Cypress tests in parallel ğŸ§ª
        uses: cypress-io/github-action@v6
        env:
          SPLIT: ${{ strategy.job-total }}
          SPLIT_INDEX: ${{ strategy.job-index }}
      - name: Save screenshots in case of failures
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: cypress-screenshots
          path: cypress/screenshots
          if-no-files-found: ignore

```

2. Acesse o arquivo `src/script.js` e quebre algo de propÃ³sito
3. Adicione todas suas mudanÃ§as (`git add .`)
4. FaÃ§a um _commit_ com a mensagem `Configure CI artifacts and break the app` (`git commit -m "Configure CI artifacts and break the app"`)
5. Envie suas mudanÃ§as locais para seu fork remoto no GitHub (`git push origin main`)
6. VÃ¡ atÃ© o GitHub e veja suas mudanÃ§as disparando o _workflow_ e um (ou mais) teste(s) falhando
7. ApÃ³s a execuÃ§Ã£o do _workflow_, baixe a _screenshot_ gerada como artefato para analisar a falha.

## ExercÃ­cio 4 ğŸ¯ - CorreÃ§Ã£o da falha

Corrija a alteraÃ§Ã£o do exercÃ­cio anterior, rode os comandos `git` necessÃ¡rios, vÃ¡ atÃ© o GitHub e veja sua mudanÃ§a disparando o _workflow_ novamente (e se tudo der certo, veja todos os testes passando de novo).

## ExercÃ­cio 5 ğŸ¯ - _test retries_

1. Atualize o arquivo de configuraÃ§Ãµes do Cypress (`cypress.config.js`) conforme abaixo:

```js
const { defineConfig } = require("cypress")

const cypressSplit = require("cypress-split")

module.exports = defineConfig({
  viewportHeight: 1024,
  viewportWidth: 1700,
  e2e: {
    fixturesFolder: false,
    retries: {
      runMode: 2,
      openMode: 0,
    },
    setupNodeEvents(on, config) {
      cypressSplit(on, config)
      return config
    }
  },
})

```

2. Para provar que os `retries` funcionam, altere o teste que simula a execuÃ§Ã£o de um comando do Cypress com sucesso para que esteja dentro do seguinte comando:

```js
Cypress._.times(100, () => {

})

```

3. Adicione todas suas mudanÃ§as (`git add .`)
4. FaÃ§a um _commit_ com a mensagem `Run the same test a hundred times` (`git commit -m "Run the same test a hundred times"`)
5. Envie suas mudanÃ§as locais para seu fork remoto no GitHub (`git push origin main`)
6. VÃ¡ atÃ© o GitHub e veja suas mudanÃ§as disparando o _workflow_ e tal teste sendo executado cem vezes, e caso ele venha a falhar, serÃ¡ re-tentado, evitando quebrar o _pipeline_.

## ConteÃºdos sugeridos da TAT ğŸ“š

- [_Playlist_ de IntegraÃ§Ã£o ContÃ­nua no Canal TAT no YouTube](https://www.youtube.com/playlist?list=PL-eblSNRj0QHgzdWNkGks9_JdhV9iAwFr)
- [Categoria IntegraÃ§Ã£o ContÃ­nua no blog Talking About Testing](https://talkingabouttesting.com/category/integracao-continua/)
- [Como rodar um teste vÃ¡rias vezes com Cypress para provar que ele Ã© estÃ¡vel](https://talkingabouttesting.com/2021/02/06/como-rodar-um-teste-varias-vezes-com-cypress-para-provar-que-ele-e-estavel/)

## Mostre ao mundo o que vocÃª aprendeu ğŸŒ

Para mostrar Ã  sua rede profissional o que vocÃª aprendeu nesta aula, publique o seguinte no LinkedIn.

> Estou fazendo o curso "_Cypress Simulator_" da escola online Talking About Testing, onde aprendi como configurar uma esteira de integraÃ§Ã£o contÃ­nua para garantir que mudanÃ§as que quebram a aplicaÃ§Ã£o sÃ£o identificadas automaticamente por uma suÃ­te de testes, como configurar _test retries_ para evitar resultados falsos negativos, como rodar tais testes em paralelo para otimizar o _feedback loop_, e por fim, como gerar artefatos de testes, tais como _screenthos_, para ajudar na depuraÃ§Ã£o de problemas. #TalkingAboutTesting #EscolaTAT #CypressSimulator #Cypress #GitHubActions
>
> ğŸ‘¨â€ğŸ« Lembre-se de me marcar em sua publicaÃ§Ã£o. [Aqui estÃ¡ meu perfil no LinkedIn](https://www.linkedin.com/in/walmyr-lima-e-silva-filho).

___

ParabÃ©ns! ğŸ‰ Vamos para a [liÃ§Ã£o 19](./19.md) para criarmos um Ãºltimo teste, de maneira a aumentar a cobertura de testes da aplicaÃ§Ã£o _Cypress Simulator_.
