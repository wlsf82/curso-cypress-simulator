# Comandos customizados

No mundo de testes automatizados com Cypress, podemos fazer uso de [comandos customizados]((https://docs.cypress.io/api/cypress-api/custom-commands)) para evitar duplicaÃ§Ã£o de cÃ³digo.

Ã‰ possÃ­vel perceber cÃ³digo duplicado tanto para a lÃ³gica do login, quanto para rodar um comando no _Cypress Simulator_.

Portanto, que tal criarmos comandos customizados para abstratir tais lÃ³gicas, remover um monte de cÃ³digo duplicado e ainda deixar o cÃ³digo mais "limpo". ğŸ«§

A propÃ³sito, deixei uma lista de conteÃºdos sugeridos pra te ajudar, logo apÃ³s a lista de exercÃ­cios.

## Conhecendo o comando `cy.session`

O processo de login da aplicaÃ§Ã£o _Cypress Playground_ Ã© bastante simples, visto que Ã© uma aplicaÃ§Ã£o criada simplesmente para fins de ensino, no entanto, em cenÃ¡rios reais, o processo de login normalmente envolve tambÃ©m o preenchimento de um formulÃ¡rio (com usuÃ¡rio e senha), e cada passo a mais que um teste precisa executar, Ã© mais tempo que o teste leva para rodar.

No entanto, o Cypress sendo a ferramenta fantÃ¡stica que Ã©, dispÃµe de um comando chamado [`cy.session`](https://docs.cypress.io/api/commands/session), o qual, dentre outras coisas, permite a otimizaÃ§Ã£o do prcesso de login, onde pode-se autenticar o usuÃ¡rio uma Ãºnica vez, guardar a sessÃ£o de tal usuÃ¡rio no navegador, e quando necessÃ¡rio, restaurar tal sessÃ£o sem a necessidade de re-executar os passos do login.

O comando `cy.session` tambÃ©m permite que a sessÃ£o seja compatilhada entre arquivos de teste (`*.cy.js`), com o uso da propriedade `cacheAcrossSpecs`.

**Fonte:** [_Caching session data across specs_](https://docs.cypress.io/api/commands/session#Caching-session-data-across-specs)

Por fim, alÃ©m do comando `cy.session` permitir restaurar uma sessÃ£o prÃ©viamente criada e compartilhÃ¡-la entre _specs_, tal comando tambÃ©m permite validar se a sessÃ£o ainda Ã© vÃ¡lida, e caso a sessÃ£o tenha sido invalidada (por um processo de logout, por exemplo), possa re-criar a sessÃ£o, de forma a fornecer resultados determinÃ­sticos durante a execuÃ§Ã£o dos testes.

> ğŸ‘¨â€ğŸ« Vale comentar que ao utilizar a funcionalidade `cy.session`, apÃ³s a criaÃ§Ã£o, restauraÃ§Ã£o, ou re-criaÃ§Ã£o da mesma, o Cypress visita uma pÃ¡gina em branco, e portanto, Ã© necessÃ¡rio um novo `cy.vist()` para a URL que deseja-se acessar.
>
> **Fonte:** [_Why are all my Cypress commands failing after calling cy.session()?_](https://docs.cypress.io/api/commands/session#Why-are-all-my-Cypress-commands-failing-after-calling-cysession)

A propÃ³sito, o Canal TAT no YouTube tem uma _playlist_ com vÃ­deos sobre esta funcionalidade e deixei o link na lista de conteÃºdos sugeridos.

## ExercÃ­cio 1 ğŸ¯ - Comando de login que salva a sessÃ£o, valida e re-cria caso necessÃ¡rio

1. Atualize o arquivo `cypress/support/commands.js` pelo seguinte:

> ğŸ™Š

```js
Cypress.Commands.add("login", () => {
  const setup = () => {
    cy.visit("./src/index.html?skipCaptcha=true")
    cy.contains("button", "Login").click()
  }

  const validate = () => {
    cy.visit("./src/index.html")
    cy.contains("button", "Login", { timeout: 1000 })
      .should("not.be.visible")
  }

  const options = {
    cacheAcrossSpecs: true,
    validate
  }

  cy.session(
    "sessionId",
    setup,
    options
  )
})

```

2. Atualize os arquivos `cypress/e2e/a11y.cy.js` e `cypress/e2e/cypress-simulator.cy.js` para que faÃ§am uso do comando `cy.login()`
3. ApÃ³s o login, lembre-se de visitar a URL adequada, dependendo se quer ou nÃ£o pular o captcha.

## ExercÃ­cio 2 ğŸ¯ - Comando `cy.run`

Crie um comando customizado chamado `cy.run`, o qual recebe como argumento um comando (como uma _string_). Tal comando deve abstrair a lÃ³gica de digitar a _string_ recebida como argumento no campo de Ã¡rea de texto (`textarea`), alÃ©m do clique no botÃ£o _Run_.

> ğŸ™Š

```js
Cypress.Commands.add('run', cmd => {
  cy.get("textarea[placeholder='Write your Cypress code here...']")
    .type(cmd)
  cy.contains("button", "Run").click()
})

```

## ConteÃºdos sugeridos ğŸ“š

- [Como criar comandos customizados com Cypress](https://talkingabouttesting.com/2021/02/10/como-criar-comandos-customizados-com-cypress/)
- [Cypress Page Object vs GUI Custom Commands](https://youtu.be/1OkfwHUJ-fk)
- [_Playlist_ cy.session do Canal TAT no YouTube](https://www.youtube.com/playlist?list=PL-eblSNRj0QF1RA4fd9FrDVov_uyYfCAL)
- [Autentique testes mais rÃ¡pido com o comando cy.session](https://talkingabouttesting.com/2021/08/07/autentique-testes-mais-rapido-com-o-comando-cy-session/)

## Mostre ao mundo o que vocÃª aprendeu ğŸŒ

Para mostrar Ã  sua rede profissional o que vocÃª aprendeu nesta aula, publique o seguinte no LinkedIn.

> Estou fazendo o curso "_Cypress Simulator_" da escola online Talking About Testing, no qual aprendi como criar comandos customizados com Cypress e como criar testes otimizados com uso da funcionalidade cy.session (compartilhando a sessÃ£o entre _specs_ e validando e re-criando a sessÃ£o quando a mesma Ã© invalidada). #TalkingAboutTesting #EscolaTAT #CypressSimulator #Cypress
>
> ğŸ‘¨â€ğŸ« Lembre-se de me marcar em sua publicaÃ§Ã£o. [Aqui estÃ¡ meu perfil no LinkedIn](https://www.linkedin.com/in/walmyr-lima-e-silva-filho).

___

ParabÃ©ns! ğŸ‰ Vamos para a [liÃ§Ã£o 18](./18.md) para implementar uma esteira de integraÃ§Ã£o contÃ­nua que executa sempre que mudanÃ§as forem enviadas ao GitHub.
